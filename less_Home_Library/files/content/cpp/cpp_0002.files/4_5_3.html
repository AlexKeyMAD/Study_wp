<head>
    <link rel="stylesheet" href="../../css/books_style.css">
</head>

<body>
    <div class="book-title">
        <p><a href="./4_5_2.html">&lArr;4.5.2 Навигация по иерархии</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="./4_6.html">4.6 Советы&rArr;</a></p>
        <h2>4.5.3. Избежание утечки ресурсов</h2>
        <hr>
        <div>
            <p>Опытные программисты должны были заметить, что я оставил открытыми три возможности для ошибок.</p>
            <ul>
                <li>Программист, реализующий Smiley, может забыть выполнить delete для указателя на mou th. </li>
                <li>Пользователь read_shape() может забыть удалить возвращаемый указатель.</li>
                <li>Владелец контейнера указателей на объекты Shape может забыть выполнить удаление объектов, на которые они указывают.</li>
            </ul>
            <p>В этом смысле указатели на объекты, размещенные в свободной памяти, оказываются опасными: "обычный старый указатель" не должен использоваться для представления владения. Например:</p>
            <img src="./4_5_3_p001.png" alt="">
            <p>Если только х не является положительным числом, мы получаем утечку. Присваивать результат выполнения оператора new "голому указателю" означает напрашиваться на неприятности.</p>
            <p>Одним простым решением такого рода проблем является использование интеллектуального указателя стандартной библиотеки unique ptr (§ 13.2.1) вместо "голого указателя" там, где требуется удаление:</p>
            <img src="./4_5_3_p002.png" alt="">
            <p>Это пример простой, общей и эффективной методики управления ресурсами (§5.3). </p>
            <p>В качестве приятного побочного эффекта этого изменения нам больше не нужно определять деструктор для Smiley. Компилятор будет неявно генерировать деструктор, который выполнит требуемое уничтожение unique _ptr (§5.3) в векторе. Код, использующий
                unique_ptr, будет таким же эффективным, как и код с обычными указателями.</p>
            <p>Теперь рассмотрим пользователей read_shape():</p>
            <img src="./4_5_3_p003.png" alt="">
            <p>Теперь каждым объектом владеет unique_ptr, который удаляет свой объект, когда он больше не нужен, т.е. когда его unique_ptr выходит из области видимости.</p>
            <p>Чтобы версия user() с использованием unique_ptr была работоспособна, нам нужны версии функций draw_all() и rotate_all(),которые принимали бы в качест.ве аргументов vector &lt;unique _ptr&lt;Shape&gt;&gt;. Написание множества таких _all()-функций
                может оказаться очень утомительным занятием; в §6.3.2 показано альтернативное решение.</p>
        </div>
    </div>
</body>